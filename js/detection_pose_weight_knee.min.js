/*!
 * Start Bootstrap - SB Admin 2 v4.1.4 (https://startbootstrap.com/theme/sb-admin-2)
 * Copyright 2013-2024 Start Bootstrap
 * Licensed under MIT (https://github.com/StartBootstrap/startbootstrap-sb-admin-2/blob/master/LICENSE)
 */

import{Camera}from"./testCamera.js";import{BLAZEPOSE_CONFIG,POSE_WEIGHT_FOR_EXERCISE_1,POSE_WEIGHT_FOR_EXERCISE_2,POSE_WEIGHT_FOR_EXERCISE_arm_l,POSE_WEIGHT_FOR_EXERCISE_arm_r,POSE_WEIGHT_FOR_EXERCISE_knee,POSE_WEIGHT_FOR_EXERCISE_knee2,POSE_WEIGHT_FOR_EXERCISE_KNEE_1,SCORE_ARRAY_ARM_2,SCORE_ARRAY_KNEE_1,STATE}from"./params.js";import{setupStats}from"./stats_panel.js";import{setBackendAndEnvFlags}from"./util.js";let detector,camera,stats,detector2,rafId,startInferenceTime,numInferences=0,inferenceTimeSum=0,lastPanelUpdate=0;var video=document.getElementById("video");let POSE_WEIGHT=POSE_WEIGHT_FOR_EXERCISE_KNEE_1,SCORE_THRESHOLD=SCORE_ARRAY_KNEE_1,jsFileName=video.src.split("/").pop().split("#")[0].split(".")[0];var canvasVideo=document.createElement("canvas");canvasVideo.width=video.offsetWidth,canvasVideo.height=video.offsetHeight;var weightedDistance,webcamPoses,videoPoses,webcam=document.getElementById("webcam"),canvasWebcam=document.createElement("output"),maxScore=0,myScore=0,videoFlag=!1;let great_cnt=0,good_cnt=0,soso_cnt=0,bad_cnt=0;function getScore(e){maxScore+=3,e<=SCORE_THRESHOLD[0]?(myScore+=3,great_cnt++):e<=SCORE_THRESHOLD[1]?(myScore+=2,good_cnt++):e<=SCORE_THRESHOLD[2]?(myScore+=1,soso_cnt++):bad_cnt++;e=getFinalScore();let t="Bad";60<=e?t="Great":40<=e?t="Good":20<=e&&(t="SoSo"),$(".score_text").text(`${t}(${parseInt(e)})`),$(".great").text(great_cnt),$(".good").text(good_cnt),$(".soso").text(soso_cnt),$(".bad").text(bad_cnt)}function getFinalScore(){return 100*myScore/maxScore}function beginEstimatePosesStats(){startInferenceTime=(performance||Date).now()}function endEstimatePosesStats(){var e=(performance||Date).now();inferenceTimeSum+=e-startInferenceTime,++numInferences;var t;1e3<=e-lastPanelUpdate&&(t=inferenceTimeSum/numInferences,inferenceTimeSum=0,numInferences=0,stats.customFpsPanel.update(1e3/t,120),lastPanelUpdate=e)}async function renderResult(){canvasVideo.getContext("2d").drawImage(video,0,0,canvasVideo.width,canvasVideo.height),beginEstimatePosesStats(),webcamPoses=await detector.estimatePoses(camera.webcam,{flipHorizontal:!1}),endEstimatePosesStats(),videoPoses=await detector2.estimatePoses(canvasVideo,{flipHorizontal:!1}),camera.drawCtx(),0<webcamPoses.length&&!STATE.isModelChanged&&(camera.drawResults(webcamPoses),(videoFlag=!video.paused)&&0<videoPoses.length&&(console.log("length : ",webcamPoses[0].keypoints3D.slice(BLAZEPOSE_CONFIG.indexStart,BLAZEPOSE_CONFIG.indexEnd).length),getScore(weightedDistance=poseSimilarity(videoPoses[0].keypoints3D.slice(BLAZEPOSE_CONFIG.indexStart,BLAZEPOSE_CONFIG.indexEnd),webcamPoses[0].keypoints3D.slice(BLAZEPOSE_CONFIG.indexStart,BLAZEPOSE_CONFIG.indexEnd))),console.log("score:",weightedDistance,myScore,maxScore)))}async function renderPrediction(){await renderResult(),rafId=requestAnimationFrame(renderPrediction)}async function app(){stats=setupStats(),detector=await poseDetection.createDetector(poseDetection.SupportedModels.BlazePose,BLAZEPOSE_CONFIG),detector2=await poseDetection.createDetector(poseDetection.SupportedModels.BlazePose,BLAZEPOSE_CONFIG),camera=await Camera.setupCamera(STATE.camera),await setBackendAndEnvFlags(STATE.flags,STATE.backend),renderPrediction()}function weightedDistanceMatching(e,t,a){for(var n=1/a[a.length-1],o=0,r=1/POSE_WEIGHT.reduce((e,t)=>e+t,0),s=0;s<e.length;s++){var c=Math.floor(s/2);o+=POSE_WEIGHT[c]*a[c]*Math.abs(e[s]-t[s])}return r*(a.length-1)*n*o}function convertPoseToVector(e){var o=[],r=Number.POSITIVE_INFINITY,s=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY,i=0,E=[],d=Array;return e.forEach(function(e,t){var a=e.x,n=e.y;o.push(a,n),r=Math.min(r,a),s=Math.min(s,n),c=Math.max(c,Math.max(a,n));a=e.score;d&&(n=!1,!d[e.name]&&0!==d[e.name]||(n=d[e.name]),!(n=d[t]||0===d[t]?d[t]:n)&&0!==n||"number"!=typeof n||(a+=n)),i+=a,E.push(a)}),E.push(i),[o,[r/c,s/c,c],E]}function scaleAndTranslate(e,t){var a=t[0],n=t[1],o=t[2];return e.map(function(e,t){return t%2==0?e/o-a:e/o-n})}function L2Normalization(e){var t=0;return e.forEach(function(e){t+=Math.pow(e,2)}),t=Math.sqrt(t),e.map(function(e){return e/t})}function vectorizeAndNormalize(e){var t=convertPoseToVector(e),a=t[0],e=t[1],t=t[2];return[a=L2Normalization(a=scaleAndTranslate(a,e)),t]}function poseSimilarity(e,t){var a=vectorizeAndNormalize(e),e=a[0],a=a[1];return weightedDistanceMatching(e,vectorizeAndNormalize(t)[0],a)}app();